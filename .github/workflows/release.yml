name: Release

on:
   workflow_run:
      workflows:
       - Integration tests
      branches: [master]
      types:
       - completed

jobs:
   release-image-to-docker-hub:
      runs-on: ubuntu-latest
      if: ${{ github.event.workflow_run.conclusion == 'success' }}
      steps:
       - name: 'Download artifact'
         uses: actions/github-script@v7
         with:
            script: |
               console.log("--> context: ", context);
               let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: context.payload.workflow_run.id,
               });
               let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
                  return artifact.name == "prevant-image"
               })[0];
               console.log("--> match artifact: ", matchArtifact);
               let download = await github.rest.actions.downloadArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: matchArtifact.id,
                  archive_format: 'zip',
               });
               const fs = require('fs');
               const path = require('path');
               const temp = '${{ runner.temp }}';
               fs.writeFileSync(path.join(temp, 'prevant-image.zip'), Buffer.from(download.data));

       - name: 'Unzip PREvant image'
         run: |
            unzip prevant-image.zip -d "${{ runner.temp }}"
            ls "${{ runner.temp }}"
